import { isEthereumWallet } from '@dynamic-labs/ethereum';
import { createPublicClient, http } from 'viem';

const USDC_ADDRESS = "0xF1815bd50389c46847f0Bda824eC8da914045D14";

const HODLJarABI = [
  {
    name: 'constructor',
    type: 'constructor',
    stateMutability: 'nonpayable',
    inputs: [
      { name: '_usdc', type: 'address' },
      { name: '_moreMarkets', type: 'address' },
      { name: '_name', type: 'string' },
      { name: '_story', type: 'string' },
      { name: '_age', type: 'uint256' },
      { name: '_fosterHome', type: 'address' }
    ]
  },
  {
    name: 'deposit',
    type: 'function',
    stateMutability: 'nonpayable',
    inputs: [
      { name: 'assets', type: 'uint256' },
      { name: 'receiver', type: 'address' }
    ],
    outputs: [{ type: 'uint256' }]
  }
];

// Add MORE Markets address
const MORE_MARKETS_ADDRESS = "0xbC92aaC2DBBF42215248B5688eB3D3d2b32F2c8d";

// Your contract bytecode from the compilation
const bytecode = "0x61010060405234801561001157600080fd5b50604051614349380380614349833981810160405281019061003391906107ec565b8584604051602001610045919061091e565b60405160208183030381529060405285604051602001610065919061096a565b60405160208183030381529060405281600390816100839190610b9c565b5080600490816100939190610b9c565b5050506000806100a8836104d360201b60201c565b91509150816100b85760126100ba565b805b60ff1660a08160ff16815250508273ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff16815250505050506001600581905550600073ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff1603610175576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161016c90610ccb565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff16036101e4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101db90610d37565b60405180910390fd5b6000845111610228576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161021f90610da3565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610297576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161028e90610e0f565b60405180910390fd5b6000821180156102a75750601282105b6102e6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102dd90610e7b565b60405180910390fd5b8573ffffffffffffffffffffffffffffffffffffffff1660c08173ffffffffffffffffffffffffffffffffffffffff16815250508473ffffffffffffffffffffffffffffffffffffffff1660e08173ffffffffffffffffffffffffffffffffffffffff16815250506040518060e001604052808581526020018481526020018273ffffffffffffffffffffffffffffffffffffffff168152602001600073ffffffffffffffffffffffffffffffffffffffff168152602001838152602001600081526020016000815250600660008201518160000190816103c79190610b9c565b5060208201518160010190816103dd9190610b9c565b5060408201518160020160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060608201518160030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506080820151816004015560a0820151816005015560c082015181600601559050507fb570c20ae08e1c1cdc8cb9d44e215fbf390b54f83735fb516116dcf5a1827e468482846040516104c093929190610ef2565b60405180910390a1505050505050610fbb565b6000806000808473ffffffffffffffffffffffffffffffffffffffff1660405160240160405160208183030381529060405263313ce56760e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516105489190610f77565b600060405180830381855afa9150503d8060008114610583576040519150601f19603f3d011682016040523d82523d6000602084013e610588565b606091505b509150915081801561059c57506020815110155b156105d4576000818060200190518101906105b79190610f8e565b905060ff801681116105d257600181945094505050506105de565b505b6000809350935050505b915091565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610622826105f7565b9050919050565b61063281610617565b811461063d57600080fd5b50565b60008151905061064f81610629565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6106a88261065f565b810181811067ffffffffffffffff821117156106c7576106c6610670565b5b80604052505050565b60006106da6105e3565b90506106e6828261069f565b919050565b600067ffffffffffffffff82111561070657610705610670565b5b61070f8261065f565b9050602081019050919050565b60005b8381101561073a57808201518184015260208101905061071f565b60008484015250505050565b6000610759610754846106eb565b6106d0565b9050828152602081018484840111156107755761077461065a565b5b61078084828561071c565b509392505050565b600082601f83011261079d5761079c610655565b5b81516107ad848260208601610746565b91505092915050565b6000819050919050565b6107c9816107b6565b81146107d457600080fd5b50565b6000815190506107e6816107c0565b92915050565b60008060008060008060c08789031215610809576108086105ed565b5b600061081789828a01610640565b965050602061082889828a01610640565b955050604087015167ffffffffffffffff811115610849576108486105f2565b5b61085589828a01610788565b945050606087015167ffffffffffffffff811115610876576108756105f2565b5b61088289828a01610788565b935050608061089389828a016107d7565b92505060a06108a489828a01610640565b9150509295509295509295565b7f484f444c204a6172202d20000000000000000000000000000000000000000000815250565b600081519050919050565b600081905092915050565b60006108f8826108d7565b61090281856108e2565b935061091281856020860161071c565b80840191505092915050565b6000610929826108b1565b600b8201915061093982846108ed565b915081905092915050565b7f484f444c2d000000000000000000000000000000000000000000000000000000815250565b600061097582610944565b60058201915061098582846108ed565b915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806109d757607f821691505b6020821081036109ea576109e9610990565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610a527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610a15565b610a5c8683610a15565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610a99610a94610a8f846107b6565b610a74565b6107b6565b9050919050565b6000819050919050565b610ab383610a7e565b610ac7610abf82610aa0565b848454610a22565b825550505050565b600090565b610adc610acf565b610ae7818484610aaa565b505050565b5b81811015610b0b57610b00600082610ad4565b600181019050610aed565b5050565b601f821115610b5057610b21816109f0565b610b2a84610a05565b81016020851015610b39578190505b610b4d610b4585610a05565b830182610aec565b50505b505050565b600082821c905092915050565b6000610b7360001984600802610b55565b1980831691505092915050565b6000610b8c8383610b62565b9150826002028217905092915050565b610ba5826108d7565b67ffffffffffffffff811115610bbe57610bbd610670565b5b610bc882546109bf565b610bd3828285610b0f565b600060209050601f831160018114610c065760008415610bf4578287015190505b610bfe8582610b80565b865550610c66565b601f198416610c14866109f0565b60005b82811015610c3c57848901518255600182019150602085019450602081019050610c17565b86831015610c595784890151610c55601f891682610b62565b8355505b6001600288020188555050505b505050505050565b600082825260208201905092915050565b7f496e76616c696420555344432061646472657373000000000000000000000000600082015250565b6000610cb5601483610c6e565b9150610cc082610c7f565b602082019050919050565b60006020820190508181036000830152610ce481610ca8565b9050919050565b7f496e76616c6964204d4f5245204d61726b657473206164647265737300000000600082015250565b6000610d21601c83610c6e565b9150610d2c82610ceb565b602082019050919050565b60006020820190508181036000830152610d5081610d14565b9050919050565b7f4e616d652063616e6e6f7420626520656d707479000000000000000000000000600082015250565b6000610d8d601483610c6e565b9150610d9882610d57565b602082019050919050565b60006020820190508181036000830152610dbc81610d80565b9050919050565b7f496e76616c696420666f7374657220686f6d6520616464726573730000000000600082015250565b6000610df9601b83610c6e565b9150610e0482610dc3565b602082019050919050565b60006020820190508181036000830152610e2881610dec565b9050919050565b7f416765206d757374206265206265747765656e203120616e6420313700000000600082015250565b6000610e65601c83610c6e565b9150610e7082610e2f565b602082019050919050565b60006020820190508181036000830152610e9481610e58565b9050919050565b6000610ea6826108d7565b610eb08185610c6e565b9350610ec081856020860161071c565b610ec98161065f565b840191505092915050565b610edd81610617565b82525050565b610eec816107b6565b82525050565b60006060820190508181036000830152610f0c8186610e9b565b9050610f1b6020830185610ed4565b610f286040830184610ee3565b949350505050565b600081519050919050565b600081905092915050565b6000610f5182610f30565b610f5b8185610f3b565b9350610f6b81856020860161071c565b80840191505092915050565b6000610f838284610f46565b915081905092915050565b600060208284031215610fa457610fa36105ed565b5b6000610fb2848285016107d7565b91505092915050565b60805160a05160c05160e05161330f61103a600039600081816108e901528181610eff015281816111a701528181611314015281816118d2015281816119550152611ac3015260008181610b0901528181610f3b01526111e401526000610ab1015260008181610ae30152818161200901526120f5015261330f6000f3fe6080604052600436106101f25760003560e01c806394bf804d1161010d578063bcaa16a2116100a0578063ce96cb771161006f578063ce96cb77146107c6578063d905777e14610803578063dd62ed3e14610840578063ef8b30f71461087d578063f3ceca29146108ba576101f9565b8063bcaa16a2146106f0578063bfa51c491461071b578063c63d75b61461074c578063c6e6f59214610789576101f9565b8063b3d7f6b9116100dc578063b3d7f6b91461060e578063b460af941461064b578063b91503a614610688578063ba087652146106b3576101f9565b806394bf804d1461053e57806395d89b411461057b578063962ca496146105a6578063a9059cbb146105d1576101f9565b806338d52e0f11610185578063512ce16411610154578063512ce1641461046e5780636e553f651461049957806370a08231146104d65780637bf2da5d14610513576101f9565b806338d52e0f1461039e5780633e413bee146103c9578063402d267d146103f45780634cdad50614610431576101f9565b80630a28a477116101c15780630a28a477146102ce57806318160ddd1461030b57806323b872dd14610336578063313ce56714610373576101f9565b806301e1d114146101fe57806306fdde031461022957806307a2d13a14610254578063095ea7b314610291576101f9565b366101f957005b600080fd5b34801561020a57600080fd5b506102136108e5565b60405161022091906125b4565b60405180910390f35b34801561023557600080fd5b5061023e61098f565b60405161024b919061265f565b60405180910390f35b34801561026057600080fd5b5061027b600480360381019061027691906126b2565b610a21565b60405161028891906125b4565b60405180910390f35b34801561029d57600080fd5b506102b860048036038101906102b3919061273d565b610a35565b6040516102c59190612798565b60405180910390f35b3480156102da57600080fd5b506102f560048036038101906102f091906126b2565b610a58565b60405161030291906125b4565b60405180910390f35b34801561031757600080fd5b50610320610a6c565b60405161032d91906125b4565b60405180910390f35b34801561034257600080fd5b5061035d600480360381019061035891906127b3565b610a76565b60405161036a9190612798565b60405180910390f35b34801561037f57600080fd5b50610388610aa5565b6040516103959190612822565b60405180910390f35b3480156103aa57600080fd5b506103b3610adf565b6040516103c0919061284c565b60405180910390f35b3480156103d557600080fd5b506103de610b07565b6040516103eb91906128c6565b60405180910390f35b34801561040057600080fd5b5061041b600480360381019061041691906128e1565b610b2b565b60405161042891906125b4565b60405180910390f35b34801561043d57600080fd5b50610458600480360381019061045391906126b2565b610b55565b60405161046591906125b4565b60405180910390f35b34801561047a57600080fd5b50610483610b69565b60405161049091906125b4565b60405180910390f35b3480156104a557600080fd5b506104c060048036038101906104bb919061290e565b610bc0565b6040516104cd91906125b4565b60405180910390f35b3480156104e257600080fd5b506104fd60048036038101906104f891906128e1565b610d43565b60405161050a91906125b4565b60405180910390f35b34801561051f57600080fd5b50610528610d8b565b6040516105359190612798565b60405180910390f35b34801561054a57600080fd5b506105656004803603810190610560919061290e565b610de7565b60405161057291906125b4565b60405180910390f35b34801561058757600080fd5b50610590610e69565b60405161059d919061265f565b60405180910390f35b3480156105b257600080fd5b506105bb610efb565b6040516105c891906125b4565b60405180910390f35b3480156105dd57600080fd5b506105f860048036038101906105f3919061273d565b610fbc565b6040516106059190612798565b60405180910390f35b34801561061a57600080fd5b50610635600480360381019061063091906126b2565b610fdf565b60405161064291906125b4565b60405180910390f35b34801561065757600080fd5b50610672600480360381019061066d919061294e565b610ff3565b60405161067f91906125b4565b60405180910390f35b34801561069457600080fd5b5061069d61110e565b6040516106aa91906125b4565b60405180910390f35b3480156106bf57600080fd5b506106da60048036038101906106d5919061294e565b61128e565b6040516106e791906125b4565b60405180910390f35b3480156106fc57600080fd5b50610705611312565b60405161071291906129c2565b60405180910390f35b34801561072757600080fd5b50610730611336565b60405161074397969594939291906129dd565b60405180910390f35b34801561075857600080fd5b50610773600480360381019061076e91906128e1565b6114b6565b60405161078091906125b4565b60405180910390f35b34801561079557600080fd5b506107b060048036038101906107ab91906126b2565b6114e0565b6040516107bd91906125b4565b60405180910390f35b3480156107d257600080fd5b506107ed60048036038101906107e891906128e1565b6114f4565b6040516107fa91906125b4565b60405180910390f35b34801561080f57600080fd5b5061082a600480360381019061082591906128e1565b611510565b60405161083791906125b4565b60405180910390f35b34801561084c57600080fd5b5061086760048036038101906108629190612a5a565b611522565b60405161087491906125b4565b60405180910390f35b34801561088957600080fd5b506108a4600480360381019061089f91906126b2565b6115a9565b6040516108b191906125b4565b60405180910390f35b3480156108c657600080fd5b506108cf6115bd565b6040516108dc91906125b4565b60405180910390f35b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663d4fac45d3061092c610adf565b6040518363ffffffff1660e01b8152600401610949929190612a9a565b602060405180830381865afa158015610966573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061098a9190612ad8565b905090565b60606003805461099e90612b34565b80601f01602080910402602001604051908101604052809291908181526020018280546109ca90612b34565b8015610a175780601f106109ec57610100808354040283529160200191610a17565b820191906000526020600020905b8154815290600101906020018083116109fa57829003601f168201915b5050505050905090565b6000610a2e8260006115c5565b9050919050565b600080610a4061161e565b9050610a4d818585611626565b600191505092915050565b6000610a65826001611638565b9050919050565b6000600254905090565b600080610a8161161e565b9050610a8e858285611691565b610a99858585611726565b60019150509392505050565b6000610aaf61181a565b7f0000000000000000000000000000000000000000000000000000000000000000610ada9190612b94565b905090565b60007f0000000000000000000000000000000000000000000000000000000000000000905090565b7f000000000000000000000000000000000000000000000000000000000000000081565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9050919050565b6000610b628260006115c5565b9050919050565b6000806301e133806006600401546012610b839190612bc9565b610b8d9190612bfd565b6006800154610b9c9190612c3f565b905080421015610bb7574281610bb29190612bc9565b610bba565b60005b91505090565b60008073ffffffffffffffffffffffffffffffffffffffff16600660030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610c55576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c4c90612cbf565b60405180910390fd5b631dcd65008314610c9b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c9290612d51565b60405180910390fd5b6000610ca7848461181f565b905033600660030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550836006600501819055504260068001819055507f264f630d9efa0d07053a31163641d9fcc0adafc9d9e76f1c37c2ce3a558d2c523385604051610d31929190612d71565b60405180910390a18091505092915050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60008073ffffffffffffffffffffffffffffffffffffffff16600660030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415905090565b600080610df3836114b6565b905080841115610e3e578284826040517f284ff667000000000000000000000000000000000000000000000000000000008152600401610e3593929190612d9a565b60405180910390fd5b6000610e4985610fdf565b9050610e5e610e5661161e565b8583886118a1565b809250505092915050565b606060048054610e7890612b34565b80601f0160208091040260200160405190810160405280929190818152602001828054610ea490612b34565b8015610ef15780601f10610ec657610100808354040283529160200191610ef1565b820191906000526020600020905b815481529060010190602001808311610ed457829003601f168201915b5050505050905090565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663c4f9870b7f00000000000000000000000000000000000000000000000000000000000000006040518263ffffffff1660e01b8152600401610f76919061284c565b602060405180830381865afa158015610f93573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610fb79190612ad8565b905090565b600080610fc761161e565b9050610fd4818585611726565b600191505092915050565b6000610fec8260016115c5565b9050919050565b6000600660020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614611088576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161107f90612e1d565b60405180910390fd5b6301e13380600660040154601261109f9190612bc9565b6110a99190612bfd565b60068001546110b89190612c3f565b4210156110fa576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110f190612eaf565b60405180910390fd5b611105848484611a3d565b90509392505050565b60008073ffffffffffffffffffffffffffffffffffffffff16600660030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16036111a3576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161119a90612f1b565b60405180910390fd5b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663d4fac45d307f00000000000000000000000000000000000000000000000000000000000000006040518363ffffffff1660e01b8152600401611220929190612a9a565b602060405180830381865afa15801561123d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112619190612ad8565b90506006600501548111611276576000611288565b600660050154816112879190612bc9565b5b91505090565b60008061129a83611510565b9050808511156112e5578285826040517fb94abeec0000000000000000000000000000000000000000000000000000000081526004016112dc93929190612d9a565b60405180910390fd5b60006112f086610b55565b90506113066112fd61161e565b8686848a611ac1565b80925050509392505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b600680600001805461134790612b34565b80601f016020809104026020016040519081016040528092919081815260200182805461137390612b34565b80156113c05780601f10611395576101008083540402835291602001916113c0565b820191906000526020600020905b8154815290600101906020018083116113a357829003601f168201915b5050505050908060010180546113d590612b34565b80601f016020809104026020016040519081016040528092919081815260200182805461140190612b34565b801561144e5780601f106114235761010080835404028352916020019161144e565b820191906000526020600020905b81548152906001019060200180831161143157829003601f168201915b5050505050908060020160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060040154908060050154908060060154905087565b60007fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9050919050565b60006114ed826000611638565b9050919050565b600061150961150283610d43565b60006115c5565b9050919050565b600061151b82610d43565b9050919050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60006115b6826000611638565b9050919050565b631dcd650081565b600061161660016115d46108e5565b6115de9190612c3f565b6115e661181a565b600a6115f2919061306e565b6115fa610a6c565b6116049190612c3f565b8486611bb9909392919063ffffffff16565b905092915050565b600033905090565b6116338383836001611c08565b505050565b600061168961164561181a565b600a611651919061306e565b611659610a6c565b6116639190612c3f565b600161166d6108e5565b6116779190612c3f565b8486611bb9909392919063ffffffff16565b905092915050565b600061169d8484611522565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8110156117205781811015611710578281836040517ffb8f41b200000000000000000000000000000000000000000000000000000000815260040161170793929190612d9a565b60405180910390fd5b61171f84848484036000611c08565b5b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036117985760006040517f96c6fd1e00000000000000000000000000000000000000000000000000000000815260040161178f919061284c565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361180a5760006040517fec442f05000000000000000000000000000000000000000000000000000000008152600401611801919061284c565b60405180910390fd5b611815838383611ddf565b505050565b600090565b60008061182b83610b2b565b905080841115611876578284826040517f79012fb200000000000000000000000000000000000000000000000000000000815260040161186d93929190612d9a565b60405180910390fd5b6000611881856115a9565b905061189661188e61161e565b8587846118a1565b809250505092915050565b6118ad84848484612004565b6118b5610adf565b73ffffffffffffffffffffffffffffffffffffffff1663095ea7b37f0000000000000000000000000000000000000000000000000000000000000000846040518363ffffffff1660e01b815260040161190f929190612d71565b6020604051808303816000875af115801561192e573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061195291906130e5565b507f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166347e7ef24611997610adf565b846040518363ffffffff1660e01b81526004016119b5929190612d71565b6020604051808303816000875af11580156119d4573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906119f891906130e5565b611a37576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611a2e9061315e565b60405180910390fd5b50505050565b600080611a49836114f4565b905080851115611a94578285826040517ffe9cceec000000000000000000000000000000000000000000000000000000008152600401611a8b93929190612d9a565b60405180910390fd5b6000611a9f86610a58565b9050611ab5611aac61161e565b86868985611ac1565b80925050509392505050565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663f3fef3a3611b05610adf565b846040518363ffffffff1660e01b8152600401611b23929190612d71565b6020604051808303816000875af1158015611b42573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611b6691906130e5565b611ba5576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611b9c906131ca565b60405180910390fd5b611bb285858585856120a7565b5050505050565b6000611be9611bc7836121a0565b8015611be4575060008480611bdf57611bde6131ea565b5b868809115b6121ce565b611bf48686866121da565b611bfe9190612c3f565b9050949350505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603611c7a5760006040517fe602df05000000000000000000000000000000000000000000000000000000008152600401611c71919061284c565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603611cec5760006040517f94280d62000000000000000000000000000000000000000000000000000000008152600401611ce3919061284c565b60405180910390fd5b81600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508015611dd9578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92584604051611dd091906125b4565b60405180910390a35b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603611e31578060026000828254611e259190612c3f565b92505081905550611f04565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015611ebd578381836040517fe450d38c000000000000000000000000000000000000000000000000000000008152600401611eb493929190612d9a565b60405180910390fd5b8181036000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550505b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603611f4d5780600260008282540392505081905550611f9a565b806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051611ff791906125b4565b60405180910390a3505050565b6120307f00000000000000000000000000000000000000000000000000000000000000008530856122c8565b61203a838261234a565b8273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fdcbc1c05240f31ff3ad067ef1ee35ce4997762752e3a095284754544f4c709d78484604051612099929190613219565b60405180910390a350505050565b8273ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff16146120e6576120e5838683611691565b5b6120f083826123cc565b61211b7f0000000000000000000000000000000000000000000000000000000000000000858461244e565b8273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff167ffbde797d201c681b91056529119e0b02407c7bb96a4a2c75c01fc9667232c8db8585604051612191929190613219565b60405180910390a45050505050565b6000600160028360038111156121b9576121b8613242565b5b6121c39190613271565b60ff16149050919050565b60008115159050919050565b60008083850290506000801985870982811083820303915050600081036122155783828161220b5761220a6131ea565b5b04925050506122c1565b8084116122355761223461222f60008614601260116124cd565b6124e7565b5b600084868809905082811182039150808303925060008560000386169050808604955080840493506001818260000304019050808302841793506000600287600302189050808702600203810290508087026002038102905080870260020381029050808702600203810290508087026002038102905080870260020381029050808502955050505050505b9392505050565b612344848573ffffffffffffffffffffffffffffffffffffffff166323b872dd8686866040516024016122fd939291906132a2565b604051602081830303815290604052915060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506124f9565b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036123bc5760006040517fec442f050000000000000000000000000000000000000000000000000000000081526004016123b3919061284c565b60405180910390fd5b6123c860008383611ddf565b5050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361243e5760006040517f96c6fd1e000000000000000000000000000000000000000000000000000000008152600401612435919061284c565b60405180910390fd5b61244a82600083611ddf565b5050565b6124c8838473ffffffffffffffffffffffffffffffffffffffff1663a9059cbb8585604051602401612481929190612d71565b604051602081830303815290604052915060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506124f9565b505050565b60006124d8846121ce565b82841802821890509392505050565b634e487b71600052806020526024601cfd5b600080602060008451602086016000885af18061251c576040513d6000823e3d81fd5b3d925060005191505060008214612537576001811415612553565b60008473ffffffffffffffffffffffffffffffffffffffff163b145b1561259557836040517f5274afe700000000000000000000000000000000000000000000000000000000815260040161258c919061284c565b60405180910390fd5b50505050565b6000819050919050565b6125ae8161259b565b82525050565b60006020820190506125c960008301846125a5565b92915050565b600081519050919050565b600082825260208201905092915050565b60005b838110156126095780820151818401526020810190506125ee565b60008484015250505050565b6000601f19601f8301169050919050565b6000612631826125cf565b61263b81856125da565b935061264b8185602086016125eb565b61265481612615565b840191505092915050565b600060208201905081810360008301526126798184612626565b905092915050565b600080fd5b61268f8161259b565b811461269a57600080fd5b50565b6000813590506126ac81612686565b92915050565b6000602082840312156126c8576126c7612681565b5b60006126d68482850161269d565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061270a826126df565b9050919050565b61271a816126ff565b811461272557600080fd5b50565b60008135905061273781612711565b92915050565b6000806040838503121561275457612753612681565b5b600061276285828601612728565b92505060206127738582860161269d565b9150509250929050565b60008115159050919050565b6127928161277d565b82525050565b60006020820190506127ad6000830184612789565b92915050565b6000806000606084860312156127cc576127cb612681565b5b60006127da86828701612728565b93505060206127eb86828701612728565b92505060406127fc8682870161269d565b9150509250925092565b600060ff82169050919050565b61281c81612806565b82525050565b60006020820190506128376000830184612813565b92915050565b612846816126ff565b82525050565b6000602082019050612861600083018461283d565b92915050565b6000819050919050565b600061288c612887612882846126df565b612867565b6126df565b9050919050565b600061289e82612871565b9050919050565b60006128b082612893565b9050919050565b6128c0816128a5565b82525050565b60006020820190506128db60008301846128b7565b92915050565b6000602082840312156128f7576128f6612681565b5b600061290584828501612728565b91505092915050565b6000806040838503121561292557612924612681565b5b60006129338582860161269d565b925050602061294485828601612728565b9150509250929050565b60008060006060848603121561296757612966612681565b5b60006129758682870161269d565b935050602061298686828701612728565b925050604061299786828701612728565b9150509250925092565b60006129ac82612893565b9050919050565b6129bc816129a1565b82525050565b60006020820190506129d760008301846129b3565b92915050565b600060e08201905081810360008301526129f7818a612626565b90508181036020830152612a0b8189612626565b9050612a1a604083018861283d565b612a27606083018761283d565b612a3460808301866125a5565b612a4160a08301856125a5565b612a4e60c08301846125a5565b98975050505050505050565b60008060408385031215612a7157612a70612681565b5b6000612a7f85828601612728565b9250506020612a9085828601612728565b9150509250929050565b6000604082019050612aaf600083018561283d565b612abc602083018461283d565b9392505050565b600081519050612ad281612686565b92915050565b600060208284031215612aee57612aed612681565b5b6000612afc84828501612ac3565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680612b4c57607f821691505b602082108103612b5f57612b5e612b05565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000612b9f82612806565b9150612baa83612806565b9250828201905060ff811115612bc357612bc2612b65565b5b92915050565b6000612bd48261259b565b9150612bdf8361259b565b9250828203905081811115612bf757612bf6612b65565b5b92915050565b6000612c088261259b565b9150612c138361259b565b9250828202612c218161259b565b91508282048414831517612c3857612c37612b65565b5b5092915050565b6000612c4a8261259b565b9150612c558361259b565b9250828201905080821115612c6d57612c6c612b65565b5b92915050565b7f484f444c206a617220616c726561647920686173206120646f6e6f7200000000600082015250565b6000612ca9601c836125da565b9150612cb482612c73565b602082019050919050565b60006020820190508181036000830152612cd881612c9c565b9050919050565b7f4d757374206465706f73697420657861637420646f6e6174696f6e20616d6f7560008201527f6e74000000000000000000000000000000000000000000000000000000000000602082015250565b6000612d3b6022836125da565b9150612d4682612cdf565b604082019050919050565b60006020820190508181036000830152612d6a81612d2e565b9050919050565b6000604082019050612d86600083018561283d565b612d9360208301846125a5565b9392505050565b6000606082019050612daf600083018661283d565b612dbc60208301856125a5565b612dc960408301846125a5565b949350505050565b7f4f6e6c7920666f7374657220686f6d652063616e207769746864726177000000600082015250565b6000612e07601d836125da565b9150612e1282612dd1565b602082019050919050565b60006020820190508181036000830152612e3681612dfa565b9050919050565b7f43616e6e6f7420776974686472617720756e74696c206b6964207475726e732060008201527f3138000000000000000000000000000000000000000000000000000000000000602082015250565b6000612e996022836125da565b9150612ea482612e3d565b604082019050919050565b60006020820190508181036000830152612ec881612e8c565b9050919050565b7f484f444c206a617220686173206e6f20646f6e6f720000000000000000000000600082015250565b6000612f056015836125da565b9150612f1082612ecf565b602082019050919050565b60006020820190508181036000830152612f3481612ef8565b9050919050565b60008160011c9050919050565b6000808291508390505b6001851115612f9257808604811115612f6e57612f6d612b65565b5b6001851615612f7d5780820291505b8081029050612f8b85612f3b565b9450612f52565b94509492505050565b600082612fab5760019050613067565b81612fb95760009050613067565b8160018114612fcf5760028114612fd957613008565b6001915050613067565b60ff841115612feb57612fea612b65565b5b8360020a91508482111561300257613001612b65565b5b50613067565b5060208310610133831016604e8410600b841016171561303d5782820a90508381111561303857613037612b65565b5b613067565b61304a8484846001612f48565b9250905081840481111561306157613060612b65565b5b81810290505b9392505050565b60006130798261259b565b915061308483612806565b92506130b17fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484612f9b565b905092915050565b6130c28161277d565b81146130cd57600080fd5b50565b6000815190506130df816130b9565b92915050565b6000602082840312156130fb576130fa612681565b5b6000613109848285016130d0565b91505092915050565b7f4d4f5245204d61726b657473206465706f736974206661696c65640000000000600082015250565b6000613148601b836125da565b915061315382613112565b602082019050919050565b600060208201905081810360008301526131778161313b565b9050919050565b7f4d4f5245204d61726b657473207769746864726177616c206661696c65640000600082015250565b60006131b4601e836125da565b91506131bf8261317e565b602082019050919050565b600060208201905081810360008301526131e3816131a7565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b600060408201905061322e60008301856125a5565b61323b60208301846125a5565b9392505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b600061327c82612806565b915061328783612806565b925082613297576132966131ea565b5b828206905092915050565b60006060820190506132b7600083018661283d565b6132c4602083018561283d565b6132d160408301846125a5565b94935050505056fea26469706673582212209fad0e2d0c473bfcbc40fb631987ffae02b69a2536c8b8048bd42291696a77a664736f6c634300081c0033" // ... rest of the bytecode

export async function createHODLJar(primaryWallet, params) {
  if (!primaryWallet || !isEthereumWallet(primaryWallet)) {
    return {
      success: false,
      message: 'Invalid wallet connection'
    };
  }

  try {
    const walletClient = await primaryWallet.getWalletClient();
    const publicClient = await primaryWallet.getPublicClient();

    // Log deployment parameters for debugging
    console.log('Starting deployment with parameters:', {
      usdc: USDC_ADDRESS,
      moreMarkets: MORE_MARKETS_ADDRESS,
      name: params.name,
      story: params.story,
      age: params.age,
      fosterHome: params.fosterHome
    });

    // Validate inputs
    if (!params.name || !params.story || !params.fosterHome) {
      return {
        success: false,
        message: 'Missing required parameters'
      };
    }

    if (params.age <= 0 || params.age >= 18) {
      return {
        success: false,
        message: 'Age must be between 1 and 17'
      };
    }

    // Prepare the deployment transaction
    const deploymentPromise = walletClient.deployContract({
      abi: HODLJarABI,
      bytecode,
      args: [
        USDC_ADDRESS,
        MORE_MARKETS_ADDRESS,
        params.name,
        params.story,
        window.BigInt(params.age),
        params.fosterHome
      ],
      account: primaryWallet.address
    });

    // Add timeout handling
    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Transaction confirmation timed out')), 180000); // 3 minutes
    });

    // Wait for either deployment or timeout
    const hash = await Promise.race([deploymentPromise, timeoutPromise]);
    console.log('Deployment transaction initiated:', hash);

    // Wait for confirmation
    const receipt = await publicClient.waitForTransactionReceipt({ 
      hash,
      timeout: 60_000, // 60 seconds for confirmation
      confirmations: 1 // Wait for 1 confirmation
    });

    if (receipt.status === 'success') {
      return {
        success: true,
        message: `HODL Jar deployed successfully! Contract address: ${receipt.contractAddress}`,
        contractAddress: receipt.contractAddress,
        hash
      };
    } else {
      return {
        success: false,
        message: 'Deployment failed. Please try again.',
        hash
      };
    }
  } catch (error) {
    console.error('Deployment error:', error);
    
    // Handle specific error types
    if (error.message.includes('Proposal expired')) {
      return {
        success: false,
        message: 'Please confirm the transaction in your wallet promptly. Try again.',
        error: error
      };
    }
    
    return {
      success: false,
      message: `Error deploying HODL Jar: ${error.message}`,
      error: error
    };
  }
}
